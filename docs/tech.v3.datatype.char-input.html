<!DOCTYPE html PUBLIC ""
    "">
<html><head><meta charset="UTF-8" /><title>tech.v3.datatype.char-input documentation</title><script async="true" src="https://www.googletagmanager.com/gtag/js?id=G-95TVFC1FEB"></script><script>window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-95TVFC1FEB');</script><link rel="stylesheet" type="text/css" href="css/default.css" /><link rel="stylesheet" type="text/css" href="highlight/solarized-light.css" /><script type="text/javascript" src="highlight/highlight.min.js"></script><script type="text/javascript" src="js/jquery.min.js"></script><script type="text/javascript" src="js/page_effects.js"></script><script>hljs.initHighlightingOnLoad();</script></head><body><div id="header"><h2>Generated by <a href="https://github.com/weavejester/codox">Codox</a> with <a href="https://github.com/xsc/codox-theme-rdash">RDash UI</a> theme</h2><h1><a href="index.html"><span class="project-title"><span class="project-name">dtype-next</span> <span class="project-version">9.023</span></span></a></h1></div><div class="sidebar primary"><h3 class="no-link"><span class="inner">Project</span></h3><ul class="index-link"><li class="depth-1 "><a href="index.html"><div class="inner">Index</div></a></li></ul><h3 class="no-link"><span class="inner">Topics</span></h3><ul><li class="depth-1 "><a href="buffered-image.html"><div class="inner"><span>dtype-next Buffered Image Support</span></div></a></li><li class="depth-1 "><a href="cheatsheet.html"><div class="inner"><span>dtype-next Cheatsheet</span></div></a></li><li class="depth-1 "><a href="datatype-to-dtype-next.html"><div class="inner"><span>Why dtype-next?</span></div></a></li><li class="depth-1 "><a href="dimensions-bytecode-gen.html"><div class="inner"><span>dtype-next Tensor Dimensions and Bytecode Generation</span></div></a></li><li class="depth-1 "><a href="overview.html"><div class="inner"><span>dtype-next Overview</span></div></a></li></ul><h3 class="no-link"><span class="inner">Namespaces</span></h3><ul><li class="depth-1"><div class="no-link"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>tech</span></div></div></li><li class="depth-2"><div class="no-link"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>v3</span></div></div></li><li class="depth-3"><a href="tech.v3.datatype.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>datatype</span></div></a></li><li class="depth-4 branch"><a href="tech.v3.datatype.argops.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>argops</span></div></a></li><li class="depth-4 branch"><a href="tech.v3.datatype.bitmap.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>bitmap</span></div></a></li><li class="depth-4 branch current"><a href="tech.v3.datatype.char-input.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>char-input</span></div></a></li><li class="depth-4 branch"><a href="tech.v3.datatype.convolve.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>convolve</span></div></a></li><li class="depth-4 branch"><a href="tech.v3.datatype.datetime.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>datetime</span></div></a></li><li class="depth-4 branch"><a href="tech.v3.datatype.errors.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>errors</span></div></a></li><li class="depth-4"><a href="tech.v3.datatype.ffi.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>ffi</span></div></a></li><li class="depth-5 branch"><a href="tech.v3.datatype.ffi.clang.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>clang</span></div></a></li><li class="depth-5 branch"><a href="tech.v3.datatype.ffi.graalvm.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>graalvm</span></div></a></li><li class="depth-5"><a href="tech.v3.datatype.ffi.size-t.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>size-t</span></div></a></li><li class="depth-4 branch"><a href="tech.v3.datatype.functional.html"><div class="inner"><span class="tree" style="top: -114px;"><span class="top" style="height: 123px;"></span><span class="bottom"></span></span><span>functional</span></div></a></li><li class="depth-4 branch"><a href="tech.v3.datatype.gradient.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>gradient</span></div></a></li><li class="depth-4 branch"><a href="tech.v3.datatype.jvm-map.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>jvm-map</span></div></a></li><li class="depth-4 branch"><a href="tech.v3.datatype.list.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>list</span></div></a></li><li class="depth-4 branch"><a href="tech.v3.datatype.locker.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>locker</span></div></a></li><li class="depth-4 branch"><a href="tech.v3.datatype.mmap.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>mmap</span></div></a></li><li class="depth-4 branch"><a href="tech.v3.datatype.mmap-writer.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>mmap-writer</span></div></a></li><li class="depth-4 branch"><a href="tech.v3.datatype.native-buffer.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>native-buffer</span></div></a></li><li class="depth-4 branch"><a href="tech.v3.datatype.nippy.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>nippy</span></div></a></li><li class="depth-4 branch"><a href="tech.v3.datatype.packing.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>packing</span></div></a></li><li class="depth-4 branch"><a href="tech.v3.datatype.reductions.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>reductions</span></div></a></li><li class="depth-4 branch"><a href="tech.v3.datatype.rolling.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>rolling</span></div></a></li><li class="depth-4 branch"><a href="tech.v3.datatype.sampling.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>sampling</span></div></a></li><li class="depth-4 branch"><a href="tech.v3.datatype.statistics.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>statistics</span></div></a></li><li class="depth-4 branch"><a href="tech.v3.datatype.struct.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>struct</span></div></a></li><li class="depth-4"><a href="tech.v3.datatype.wavelet.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>wavelet</span></div></a></li><li class="depth-3"><div class="no-link"><div class="inner"><span class="tree" style="top: -827px;"><span class="top" style="height: 836px;"></span><span class="bottom"></span></span><span>libs</span></div></div></li><li class="depth-4 branch"><a href="tech.v3.libs.buffered-image.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>buffered-image</span></div></a></li><li class="depth-4"><a href="tech.v3.libs.neanderthal.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>neanderthal</span></div></a></li><li class="depth-3"><div class="no-link"><div class="inner"><span class="tree" style="top: -83px;"><span class="top" style="height: 92px;"></span><span class="bottom"></span></span><span>parallel</span></div></div></li><li class="depth-4 branch"><a href="tech.v3.parallel.for.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>for</span></div></a></li><li class="depth-4"><a href="tech.v3.parallel.queue-iter.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>queue-iter</span></div></a></li><li class="depth-3"><a href="tech.v3.tensor.html"><div class="inner"><span class="tree" style="top: -83px;"><span class="top" style="height: 92px;"></span><span class="bottom"></span></span><span>tensor</span></div></a></li><li class="depth-4 branch"><a href="tech.v3.tensor.color-gradients.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>color-gradients</span></div></a></li><li class="depth-4"><a href="tech.v3.tensor.dimensions.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>dimensions</span></div></a></li></ul></div><div class="sidebar secondary"><h3><a href="#top"><span class="inner">Public Vars</span></a></h3><ul><li class="depth-1"><a href="tech.v3.datatype.char-input.html#var-char-ary-cls"><div class="inner"><span>char-ary-cls</span></div></a></li><li class="depth-1"><a href="tech.v3.datatype.char-input.html#var-parse-json-fn"><div class="inner"><span>parse-json-fn</span></div></a></li><li class="depth-1"><a href="tech.v3.datatype.char-input.html#var-read-csv"><div class="inner"><span>read-csv</span></div></a></li><li class="depth-1"><a href="tech.v3.datatype.char-input.html#var-read-csv-compat"><div class="inner"><span>read-csv-compat</span></div></a></li><li class="depth-1"><a href="tech.v3.datatype.char-input.html#var-read-json"><div class="inner"><span>read-json</span></div></a></li><li class="depth-1"><a href="tech.v3.datatype.char-input.html#var-read-json-fn"><div class="inner"><span>read-json-fn</span></div></a></li><li class="depth-1"><a href="tech.v3.datatype.char-input.html#var-reader-.3Echar-buf-fn"><div class="inner"><span>reader-&gt;char-buf-fn</span></div></a></li><li class="depth-1"><a href="tech.v3.datatype.char-input.html#var-reader-.3Echar-reader"><div class="inner"><span>reader-&gt;char-reader</span></div></a></li></ul></div><div class="namespace-docs" id="content"><h1 class="anchor" id="top">tech.v3.datatype.char-input</h1><div class="doc"><div class="markdown"><p>Efficient ways to read files via the java.io.Reader interface.  You can read a file
into an iterator of (fixed rotating) character buffers, create a new and much
faster reader-like interface from the character buffers and parse a csv/tsv type
file with an interface that is mostly compatible with but far faster than clojure.data.csv.</p>
<p>Files are by default read by a separate thread into character arrays and those arrays are
then processed.  For details around the threading system see <a href="tech.v3.parallel.queue-iter.html">tech.v3.parallel.queue-iter</a>.</p>
<p>CSV parsing is broken up into two parts.  The first is reading a file and creating an iterator
of char[] buffers.  The second is parsing an iterator of char[] buffers.  As mentioned earlier
we further move the file-&gt;char buffer parsing off onto an offline thread.</p>
<p>This design is meant to be easy to experiment with.  It could be that an mmap-based pathway
allows us to read the file faster, it could be that parsing into blocks of rows as opposed
to char[]s in an offline thread is faster, etc.</p>
<p>Overall parsing many csv's in parallel will a better strategy than using many threads to
make parsing a single csv incrementally faster so this current design keeps the memory
requirements for a single csv quite low while still gaining the majority of meaningful
performance benefits.</p>
<p>Supporting Java classes:</p>
<ul>
<li><a href="https://github.com/cnuernber/dtype-next/blob/master/java/tech/v3/datatype/CharBuffer.java">CharBuffer.java</a> -
StringBuilder-like class that implements whitespace trimming, clear, and nil empty strings.</li>
<li><a href="https://github.com/cnuernber/dtype-next/blob/master/java/tech/v3/datatype/CharReader.java">CharReader.java</a> -
A java.io.Reader-like class that only correctly implements single-character unread but allows access
to the underlying buffer.</li>
<li><a href="https://github.com/cnuernber/dtype-next/blob/master/java/tech/v3/datatype/CSVReader.java">CSVReader.java</a> -
All the tight loops necessary to parse a CSV file quickly.</li>
<li><a href="https://github.com/cnuernber/dtype-next/blob/master/java/tech/v3/datatype/JSONReader.java">JSONReader.java</a> -
All the tight loops necessary to parse a JSON file.  Fairly customizeable.</li>
</ul>
</div></div><div class="public anchor" id="var-char-ary-cls"><h3>char-ary-cls</h3><div class="usage"></div><div class="doc"><div class="markdown"></div></div><div class="src-link"><a href="https://github.com/cnuernber/dtype-next/blob/master/src/tech/v3/datatype/char_input.clj#L144">view source</a></div></div><div class="public anchor" id="var-parse-json-fn"><h3>parse-json-fn</h3><div class="usage"><code>(parse-json-fn &amp; [options])</code></div><div class="doc"><div class="markdown"><p>Return a function from input-&gt;json.  Reuses the parse context.
Same options as <a href="tech.v3.datatype.char-input.html#var-read-json-fn">read-json-fn</a>.</p>
</div></div><div class="src-link"><a href="https://github.com/cnuernber/dtype-next/blob/master/src/tech/v3/datatype/char_input.clj#L460">view source</a></div></div><div class="public anchor" id="var-read-csv"><h3>read-csv</h3><div class="usage"><code>(read-csv input &amp; [options])</code></div><div class="doc"><div class="markdown"><p>Read a csv into a row iterator.  Parse algorithm the same as clojure.data.csv although
this returns an iterator and each row is an ArrayList as opposed to a persistent
vector.  To convert a java.util.List into something with the same equal and hash semantics
of a persistent vector use either <code>tech.v3.datatype.ListPersistentVector</code> or <code>vec</code>.  To
convert an iterator to a sequence use iterator-seq.</p>
<p>The iterator returned derives from AutoCloseable and it will terminate the iteration and
close the underlying iterator (and join the async thread) if (.close iter) is called.</p>
<p>For a drop-in but much faster replacement to clojure.data.csv use <a href="tech.v3.datatype.char-input.html#var-read-csv-compat">read-csv-compat</a>.</p>
<p>Options:</p>
<ul>
<li><code>:async?</code> - Defaults to true - read the file into buffers in an offline thread.  This
speeds up reading larger files (1MB+) by about 30%.</li>
<li><code>:separator</code> - Field separator - defaults to ,.</li>
<li><code>:quote</code> - Quote specifier - defaults to //".</li>
<li><code>:close-reader?</code> - Close the reader when iteration is finished - defaults to true.</li>
<li><code>:column-whitelist</code> - Sequence of allowed column names.</li>
<li><code>:column-blacklist</code> - Sequence of dis-allowed column names.  When conflicts with
<code>:column-whitelist</code> then <code>:column-whitelist</code> wins.</li>
<li><code>:trim-leading-whitespace?</code> - When true, leading spaces and tabs are ignored.  Defaults to true.</li>
<li><code>:trim-trailing-whitespace?</code> - When true, trailing spaces and tabs are ignored.  Defaults
to true</li>
<li><code>:nil-empty-values?</code> - When true, empty strings are elided entirely and returned as nil
values. Defaults to true.</li>
</ul>
</div></div><div class="src-link"><a href="https://github.com/cnuernber/dtype-next/blob/master/src/tech/v3/datatype/char_input.clj#L198">view source</a></div></div><div class="public anchor" id="var-read-csv-compat"><h3>read-csv-compat</h3><div class="usage"><code>(read-csv-compat input &amp; options)</code></div><div class="doc"><div class="markdown"><p>Read a csv returning a clojure.data.csv-compatible sequence.  For options
see <a href="tech.v3.datatype.char-input.html#var-read-csv">read-csv</a>.</p>
</div></div><div class="src-link"><a href="https://github.com/cnuernber/dtype-next/blob/master/src/tech/v3/datatype/char_input.clj#L299">view source</a></div></div><div class="public anchor" id="var-read-json"><h3>read-json</h3><div class="usage"><code>(read-json input &amp; args)</code></div><div class="doc"><div class="markdown"><p>Drop in replacement for clojure.data.json/read and clojure.data.json/read-str.  For options
see <a href="tech.v3.datatype.char-input.html#var-read-json-fn">read-json-fn</a>.</p>
</div></div><div class="src-link"><a href="https://github.com/cnuernber/dtype-next/blob/master/src/tech/v3/datatype/char_input.clj#L450">view source</a></div></div><div class="public anchor" id="var-read-json-fn"><h3>read-json-fn</h3><div class="usage"><code>(read-json-fn input &amp; [options])</code></div><div class="doc"><div class="markdown"><p>Most efficient read pathway for json.
Returns an auto-closeable function that when called by default throws an exception
if the read pathway is finished.  Input may be a character array or string (most efficient)
or something convertible to a reader.  Options for conversion to reader are described in
<a href="tech.v3.datatype.char-input.html#var-reader-.3Echar-reader">reader-&gt;char-reader</a> although for the json case we default <code>:async?</code> to false as
most json is just too small to benefit from async reading of the input.</p>
<p>Options:</p>
<ul>
<li><code>:bigdec</code> - When true use bigdecimals for floating point numbers.  Defaults to false.</li>
<li><code>:double-fn</code> - If :bigdec isn't provided, use this function to parse double values.</li>
<li><code>:profile</code> - Which performance profile to use.  This simply provides defaults to
<code>:array-fn</code> and <code>:obj-fn</code>. The default <code>:immutable</code> value produces persistent datastructures.
<code>:mutable</code> produces an object arrays and java.util.HashMaps - this is about
30% faster.  <code>:mixed</code> produces a mixture of persistent maps has hashmaps and is nearly as fast
as <code>:raw</code> while still being very useable and <code>:raw</code> produces an object[] for arrays and a
JSONObj type with a public data member that is an object[] for objects.</li>
<li><code>:key-fn</code> - Function called on each string map key.</li>
<li><code>:value-fn</code> - Function called on each map value.  Function is passed the key and val so it
takes 2 arguments.  If this function returns <code>:tech.v3.datatype.char-input/elided</code> then
the key-val pair will be elided from the result.</li>
<li><code>:array-fn</code> - Function called on the object array of values for a javascript array.</li>
<li><code>:obj-fn</code> - Function called on the flattened object array of key values for each javascript
object.  An acceptible although inefficient function would be <code>#(apply hash-map %)</code>.</li>
<li><code>:eof-error?</code> - Defaults to true - when eof is encountered when attempting to read an
object throw an EOF error.  Else returns a special EOF value.</li>
<li><code>:eof-value</code> - EOF value.  Defaults to</li>
<li><code>:eof-fn</code> - Function called if readObject is going to return EOF.  Defaults to throwing an
EOFException.</li>
</ul>
</div></div><div class="src-link"><a href="https://github.com/cnuernber/dtype-next/blob/master/src/tech/v3/datatype/char_input.clj#L404">view source</a></div></div><div class="public anchor" id="var-reader-.3Echar-buf-fn"><h3>reader-&gt;char-buf-fn</h3><div class="usage"><code>(reader-&gt;char-buf-fn rdr &amp; [options])</code></div><div class="doc"><div class="markdown"><p>Given a reader, return a clojure fn that when called reads the next buffer of the reader.
This function iterates through a fixed number of buffers under the covers so you need to
be cognizant of the number of actual buffers that you want to have present in memory.
This fn also implement <code>AutoCloseable</code> and closing it will close the underlying reader.</p>
<p>Options:</p>
<ul>
<li><code>:n-buffers</code> - Number of buffers to use.  Defaults to 8 - if this number is too small
then buffers in flight will get overwritten.</li>
<li><code>:bufsize</code> - Size of each buffer - defaults to 2048.  Small improvements are sometimes
seen with larger or smaller buffers.</li>
<li><code>:async?</code> - defaults to false.  When true data is read in an async thread.</li>
<li><code>:close-reader?</code> - When true, close input reader when finished.  Defaults to true.</li>
</ul>
</div></div><div class="src-link"><a href="https://github.com/cnuernber/dtype-next/blob/master/src/tech/v3/datatype/char_input.clj#L92">view source</a></div></div><div class="public anchor" id="var-reader-.3Echar-reader"><h3>reader-&gt;char-reader</h3><div class="usage"><code>(reader-&gt;char-reader rdr &amp; [options])</code></div><div class="doc"><div class="markdown"><p>Given a reader, return a CharReader which presents some of the same interface
as a pushbackreader but is only capable of pushing back 1 character.</p>
<p>Options:</p>
<p>Options are passed through mainly unchanged to queue-iter and to
<a href="reader--char-buf-iter">reader-&gt;char-buf-iter</a>.</p>
<ul>
<li><code>:async?</code> - default to true - reads the reader in an offline thread into character
buffers.</li>
</ul>
</div></div><div class="src-link"><a href="https://github.com/cnuernber/dtype-next/blob/master/src/tech/v3/datatype/char_input.clj#L147">view source</a></div></div></div></body></html>