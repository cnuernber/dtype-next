<!DOCTYPE html PUBLIC ""
    "">
<html><head><meta charset="UTF-8" /><title>tech.v3.datatype.ffi documentation</title><link rel="stylesheet" type="text/css" href="css/default.css" /><link rel="stylesheet" type="text/css" href="highlight/solarized-light.css" /><script type="text/javascript" src="highlight/highlight.min.js"></script><script type="text/javascript" src="js/jquery.min.js"></script><script type="text/javascript" src="js/page_effects.js"></script><script>hljs.initHighlightingOnLoad();</script></head><body><div id="header"><h2>Generated by <a href="https://github.com/weavejester/codox">Codox</a> with <a href="https://github.com/xsc/codox-theme-rdash">RDash UI</a> theme</h2><h1><a href="index.html"><span class="project-title"><span class="project-name">dtype-next</span> <span class="project-version">8.048</span></span></a></h1></div><div class="sidebar primary"><h3 class="no-link"><span class="inner">Project</span></h3><ul class="index-link"><li class="depth-1 "><a href="index.html"><div class="inner">Index</div></a></li></ul><h3 class="no-link"><span class="inner">Topics</span></h3><ul><li class="depth-1 "><a href="buffered-image.html"><div class="inner"><span>Buffered Image Support</span></div></a></li><li class="depth-1 "><a href="cheatsheet.html"><div class="inner"><span>Cheatsheet</span></div></a></li><li class="depth-1 "><a href="datatype-to-dtype-next.html"><div class="inner"><span>Why dtype-next?</span></div></a></li><li class="depth-1 "><a href="dimensions-bytecode-gen.html"><div class="inner"><span>Dimensions and Bytecode Generation</span></div></a></li><li class="depth-1 "><a href="overview.html"><div class="inner"><span>Overview</span></div></a></li></ul><h3 class="no-link"><span class="inner">Namespaces</span></h3><ul><li class="depth-1"><div class="no-link"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>tech</span></div></div></li><li class="depth-2"><div class="no-link"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>v3</span></div></div></li><li class="depth-3"><a href="tech.v3.datatype.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>datatype</span></div></a></li><li class="depth-4 branch"><a href="tech.v3.datatype.argops.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>argops</span></div></a></li><li class="depth-4 branch"><a href="tech.v3.datatype.bitmap.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>bitmap</span></div></a></li><li class="depth-4 branch"><a href="tech.v3.datatype.convolve.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>convolve</span></div></a></li><li class="depth-4 branch"><a href="tech.v3.datatype.datetime.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>datetime</span></div></a></li><li class="depth-4 branch"><a href="tech.v3.datatype.errors.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>errors</span></div></a></li><li class="depth-4 current"><a href="tech.v3.datatype.ffi.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>ffi</span></div></a></li><li class="depth-5 branch"><a href="tech.v3.datatype.ffi.clang.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>clang</span></div></a></li><li class="depth-5"><a href="tech.v3.datatype.ffi.graalvm.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>graalvm</span></div></a></li><li class="depth-4 branch"><a href="tech.v3.datatype.functional.html"><div class="inner"><span class="tree" style="top: -83px;"><span class="top" style="height: 92px;"></span><span class="bottom"></span></span><span>functional</span></div></a></li><li class="depth-4 branch"><a href="tech.v3.datatype.gradient.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>gradient</span></div></a></li><li class="depth-4 branch"><a href="tech.v3.datatype.jvm-map.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>jvm-map</span></div></a></li><li class="depth-4 branch"><a href="tech.v3.datatype.list.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>list</span></div></a></li><li class="depth-4 branch"><a href="tech.v3.datatype.locker.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>locker</span></div></a></li><li class="depth-4 branch"><a href="tech.v3.datatype.mmap.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>mmap</span></div></a></li><li class="depth-4 branch"><a href="tech.v3.datatype.mmap-writer.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>mmap-writer</span></div></a></li><li class="depth-4 branch"><a href="tech.v3.datatype.native-buffer.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>native-buffer</span></div></a></li><li class="depth-4 branch"><a href="tech.v3.datatype.nippy.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>nippy</span></div></a></li><li class="depth-4 branch"><a href="tech.v3.datatype.packing.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>packing</span></div></a></li><li class="depth-4 branch"><a href="tech.v3.datatype.reductions.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>reductions</span></div></a></li><li class="depth-4 branch"><a href="tech.v3.datatype.rolling.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>rolling</span></div></a></li><li class="depth-4 branch"><a href="tech.v3.datatype.sampling.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>sampling</span></div></a></li><li class="depth-4 branch"><a href="tech.v3.datatype.struct.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>struct</span></div></a></li><li class="depth-4"><a href="tech.v3.datatype.wavelet.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>wavelet</span></div></a></li><li class="depth-3"><div class="no-link"><div class="inner"><span class="tree" style="top: -734px;"><span class="top" style="height: 743px;"></span><span class="bottom"></span></span><span>libs</span></div></div></li><li class="depth-4 branch"><a href="tech.v3.libs.buffered-image.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>buffered-image</span></div></a></li><li class="depth-4"><a href="tech.v3.libs.neanderthal.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>neanderthal</span></div></a></li><li class="depth-3"><div class="no-link"><div class="inner"><span class="tree" style="top: -83px;"><span class="top" style="height: 92px;"></span><span class="bottom"></span></span><span>parallel</span></div></div></li><li class="depth-4"><a href="tech.v3.parallel.for.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>for</span></div></a></li><li class="depth-3"><a href="tech.v3.tensor.html"><div class="inner"><span class="tree" style="top: -52px;"><span class="top" style="height: 61px;"></span><span class="bottom"></span></span><span>tensor</span></div></a></li><li class="depth-4 branch"><a href="tech.v3.tensor.color-gradients.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>color-gradients</span></div></a></li><li class="depth-4"><a href="tech.v3.tensor.dimensions.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>dimensions</span></div></a></li></ul></div><div class="sidebar secondary"><h3><a href="#top"><span class="inner">Public Vars</span></a></h3><ul><li class="depth-1"><a href="tech.v3.datatype.ffi.html#var-c-.3Estring"><div class="inner"><span>c-&gt;string</span></div></a></li><li class="depth-1"><a href="tech.v3.datatype.ffi.html#var-clear-string-.3Ec-stats.21"><div class="inner"><span>clear-string-&gt;c-stats!</span></div></a></li><li class="depth-1"><a href="tech.v3.datatype.ffi.html#var-define-foreign-interface"><div class="inner"><span>define-foreign-interface</span></div></a></li><li class="depth-1"><a href="tech.v3.datatype.ffi.html#var-define-library"><div class="inner"><span>define-library</span></div></a></li><li class="depth-1"><a href="tech.v3.datatype.ffi.html#var-define-library.21"><div class="inner"><span>define-library!</span></div></a></li><li class="depth-1"><a href="tech.v3.datatype.ffi.html#var-define-library-functions"><div class="inner"><span>define-library-functions</span></div></a></li><li class="depth-1"><a href="tech.v3.datatype.ffi.html#var-define-library-interface"><div class="inner"><span>define-library-interface</span></div></a></li><li class="depth-1"><a href="tech.v3.datatype.ffi.html#var-enable-string-.3Ec-stats.21"><div class="inner"><span>enable-string-&gt;c-stats!</span></div></a></li><li class="depth-1"><a href="tech.v3.datatype.ffi.html#var-find-library"><div class="inner"><span>find-library</span></div></a></li><li class="depth-1"><a href="tech.v3.datatype.ffi.html#var-find-symbol"><div class="inner"><span>find-symbol</span></div></a></li><li class="depth-1"><a href="tech.v3.datatype.ffi.html#var-foreign-interface-instance-.3Ec"><div class="inner"><span>foreign-interface-instance-&gt;c</span></div></a></li><li class="depth-1"><a href="tech.v3.datatype.ffi.html#var-if-class"><div class="inner"><span>if-class</span></div></a></li><li class="depth-1"><a href="tech.v3.datatype.ffi.html#var-instantiate-class"><div class="inner"><span>instantiate-class</span></div></a></li><li class="depth-1"><a href="tech.v3.datatype.ffi.html#var-instantiate-foreign-interface"><div class="inner"><span>instantiate-foreign-interface</span></div></a></li><li class="depth-1"><a href="tech.v3.datatype.ffi.html#var-instantiate-library"><div class="inner"><span>instantiate-library</span></div></a></li><li class="depth-1"><a href="tech.v3.datatype.ffi.html#var-jdk-ffi.3F"><div class="inner"><span>jdk-ffi?</span></div></a></li><li class="depth-1"><a href="tech.v3.datatype.ffi.html#var-jdk-mmodel.3F"><div class="inner"><span>jdk-mmodel?</span></div></a></li><li class="depth-1"><a href="tech.v3.datatype.ffi.html#var-jna-ffi.3F"><div class="inner"><span>jna-ffi?</span></div></a></li><li class="depth-1"><a href="tech.v3.datatype.ffi.html#var-library-loadable.3F"><div class="inner"><span>library-loadable?</span></div></a></li><li class="depth-1"><a href="tech.v3.datatype.ffi.html#var-library-singleton"><div class="inner"><span>library-singleton</span></div></a></li><li class="depth-1"><a href="tech.v3.datatype.ffi.html#var-make-ptr"><div class="inner"><span>make-ptr</span></div></a></li><li class="depth-1"><a href="tech.v3.datatype.ffi.html#var-PLibrarySingleton"><div class="inner"><span>PLibrarySingleton</span></div></a></li><li class="depth-2 branch"><a href="tech.v3.datatype.ffi.html#var-library-singleton-definition"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>library-singleton-definition</span></div></a></li><li class="depth-2 branch"><a href="tech.v3.datatype.ffi.html#var-library-singleton-find-fn"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>library-singleton-find-fn</span></div></a></li><li class="depth-2 branch"><a href="tech.v3.datatype.ffi.html#var-library-singleton-find-symbol"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>library-singleton-find-symbol</span></div></a></li><li class="depth-2 branch"><a href="tech.v3.datatype.ffi.html#var-library-singleton-library"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>library-singleton-library</span></div></a></li><li class="depth-2 branch"><a href="tech.v3.datatype.ffi.html#var-library-singleton-library-path"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>library-singleton-library-path</span></div></a></li><li class="depth-2 branch"><a href="tech.v3.datatype.ffi.html#var-library-singleton-reset.21"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>library-singleton-reset!</span></div></a></li><li class="depth-2 branch"><a href="tech.v3.datatype.ffi.html#var-library-singleton-set.21"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>library-singleton-set!</span></div></a></li><li class="depth-2"><a href="tech.v3.datatype.ffi.html#var-library-singleton-set-instance.21"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>library-singleton-set-instance!</span></div></a></li><li class="depth-1"><a href="tech.v3.datatype.ffi.html#var-PToPointer"><div class="inner"><span>PToPointer</span></div></a></li><li class="depth-2 branch"><a href="tech.v3.datatype.ffi.html#var--.3Epointer"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>-&gt;pointer</span></div></a></li><li class="depth-2"><a href="tech.v3.datatype.ffi.html#var-convertible-to-pointer.3F"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>convertible-to-pointer?</span></div></a></li><li class="depth-1"><a href="tech.v3.datatype.ffi.html#var-ptr-.3Estruct"><div class="inner"><span>ptr-&gt;struct</span></div></a></li><li class="depth-1"><a href="tech.v3.datatype.ffi.html#var-set-ffi-impl.21"><div class="inner"><span>set-ffi-impl!</span></div></a></li><li class="depth-1"><a href="tech.v3.datatype.ffi.html#var-string-.3Ec"><div class="inner"><span>string-&gt;c</span></div></a></li><li class="depth-1"><a href="tech.v3.datatype.ffi.html#var-string-.3Ec-data-histogram"><div class="inner"><span>string-&gt;c-data-histogram</span></div></a></li><li class="depth-1"><a href="tech.v3.datatype.ffi.html#var-struct-member-ptr"><div class="inner"><span>struct-member-ptr</span></div></a></li><li class="depth-1"><a href="tech.v3.datatype.ffi.html#var-utf16-platform-encoding"><div class="inner"><span>utf16-platform-encoding</span></div></a></li><li class="depth-1"><a href="tech.v3.datatype.ffi.html#var-utf32-platform-encoding"><div class="inner"><span>utf32-platform-encoding</span></div></a></li><li class="depth-1"><a href="tech.v3.datatype.ffi.html#var-windows-platform.3F"><div class="inner"><span>windows-platform?</span></div></a></li></ul></div><div class="namespace-docs" id="content"><h1 class="anchor" id="top">tech.v3.datatype.ffi</h1><div class="doc"><div class="markdown"><p>Generalized C Foreign Function Interface (FFI) that unifies JNA and JDK-16 FFI architectures.</p>
<p>Users can dynamically define and load libraries and define callbacks that C can then
call.</p>
<p>This namespace is meant to work with the <code>struct</code> namespace where you can define
C-structs laid out precisely in memory.</p>
<p>Available datatypes for the binding layer:</p>
<ul>
<li><code>:int8</code> <code>:int16</code> <code>:int32</code> <code>:int64</code> <code>:float32</code> <code>:float64</code> <code>:pointer</code> <code>:pointer?</code>
<code>:size-t</code>.</li>
</ul>
<p><code>:pointer</code>, <code>:pointer?</code>, <code>:size-t</code> are all types that change their underlying
definition depending on if the system is 32 bit or 64 bit.</p>
<p>Note that unsigned types will work but the interface will have to be defined in
terms of their signed analogues.</p>
<p>Example:</p>
<pre><code class="language-clojure">user&gt; (require '[tech.v3.datatype.ffi :as dtype-ffi])
nil
user&gt; (dtype-ffi/define-library!
        clib
        '{:memset {:rettype :pointer
                   :argtypes [[buffer :pointer]
                              [byte-value :int32]
                              [n-bytes :size-t]]}
          :memcpy {:rettype :pointer
                   ;;dst src size-t
                   :argtypes [[dst :pointer]
                              [src :pointer]
                              [n-bytes :size-t]]}
          :qsort {:rettype :void
                  :argtypes [[data :pointer]
                             [nitems :size-t]
                             [item-size :size-t]
                             [comparator :pointer]]}}
        nil ;;no library symbols defined
        nil ;;no systematic error checking
        )

nil
user&gt; ;;now we bind to a path or existing library.  nil means find
user&gt; ;;symbols in current executable.
user&gt; (dtype-ffi/library-singleton-set! clib nil)
#&lt;G__17822@7f71640c:
  {:qsort #object[tech.v3.datatype.ffi.jna.G__17822$invoker_qsort 0x32b4a8cd "tech.v3.datatype.ffi.jna.G__17822$invoker_qsort@32b4a8cd"], :memset #object[tech.v3.datatype.ffi.jna.G__17822$invoker_memset 0x676ccb88 "tech.v3.datatype.ffi.jna.G__17822$invoker_memset@676ccb88"], :memcpy #object[tech.v3.datatype.ffi.jna.G__17822$invoker_memcpy 0x59fd3d8f "tech.v3.datatype.ffi.jna.G__17822$invoker_memcpy@59fd3d8f"]}&gt;
user&gt; ;;We can now call functions in our library.
user&gt; (require '[tech.v3.datatype :as dtype])
nil
user&gt; (def container (dtype/make-container :native-heap :float64 (range 10)))
#'user/container
user&gt; (apply + container)
45.0
user&gt; (memset container 0 (* (dtype/ecount container) 8))
#object[tech.v3.datatype.ffi.Pointer 0x59fa4fe0 "{:address 0x00007F1B4458C0E0 }"]
user&gt; (apply + container)
0.0
user&gt; ;;C callbacks take a bit more effort
user&gt; ;;First define the callback signature.
user&gt; (def comp-iface (dtype-ffi/define-foreign-interface :int32 [:pointer :pointer]))
#'user/comp-iface
user&gt; ;;Then instantiate an implementation.
user&gt; (import [tech.v3.datatype.ffi Pointer])
user&gt; (require '[tech.v3.datatype.native-buffer :as native-buffer])
nil
user&gt; (def iface-inst (dtype-ffi/instantiate-foreign-interface
                       comp-iface
                       (fn [^Pointer lhs ^Pointer rhs]
                         (let [lhs (.getDouble (native-buffer/unsafe) (.address lhs))
                               rhs (.getDouble (native-buffer/unsafe) (.address rhs))]
                           (Double/compare lhs rhs)))))
#'user/iface-inst
user&gt; iface-inst
#object[tech.v3.datatype.ffi.jna.ffi_G__17831 0x6e9ddc45 "tech.v3.datatype.ffi.jna.ffi_G__17831@6e9ddc45"]
user&gt; ;;From an instance of a foreign interface we can get an integer pointer
user&gt; (def iface-ptr (dtype-ffi/foreign-interface-instance-&gt;c comp-iface iface-inst))
#'user/iface-ptr
user&gt; iface-ptr
#object[tech.v3.datatype.ffi.Pointer 0x47099d5d "{:address 0x00007F1BB400F390 }"]
user&gt; ;;reset container
user&gt; (dtype/copy! (vec (shuffle (range 10))) container)
#native-buffer@0x00007F1B4458C0E0&lt;float64&gt;[10]
[5.000, 9.000, 8.000, 1.000, 3.000, 0.000, 6.000, 7.000, 4.000, 2.000]
user&gt; (qsort container 10 8 iface-ptr)
nil
user&gt; container
#native-buffer@0x00007F1B4458C0E0&lt;float64&gt;[10]
[0.000, 1.000, 2.000, 3.000, 4.000, 5.000, 6.000, 7.000, 8.000, 9.000]
</code></pre>
<p>Structs can be defined and passed by pointer/reference.  See the <a href="tech.v3.datatype.struct.html">tech.v3.datatype.struct</a>
namespace.  Also note that the output of clang can be used to define your structs based on
parsing c/c++ header files.  See <a href="tech.v3.datatype.ffi.clang.html#var-defstruct-from-layout">tech.v3.datatype.ffi.clang/defstruct-from-layout</a>.</p>
</div></div><div class="public anchor" id="var-c-.3Estring"><h3>c-&gt;string</h3><div class="usage"><code>(c-&gt;string data &amp; [encoding])</code></div><div class="doc"><div class="markdown"><p>Convert a zero-terminated c-string to a java string.  See documentation for
<code>string-&gt;c</code> for encodings.</p>
</div></div><div class="src-link"><a href="https://github.com/cnuernber/dtype-next/blob/master/src/tech/v3/datatype/ffi.clj#L255">view source</a></div></div><div class="public anchor" id="var-clear-string-.3Ec-stats.21"><h3>clear-string-&gt;c-stats!</h3><div class="usage"><code>(clear-string-&gt;c-stats!)</code></div><div class="doc"><div class="markdown"></div></div><div class="src-link"><a href="https://github.com/cnuernber/dtype-next/blob/master/src/tech/v3/datatype/ffi.clj#L217">view source</a></div></div><div class="public anchor" id="var-define-foreign-interface"><h3>define-foreign-interface</h3><div class="usage"><code>(define-foreign-interface rettype argtypes &amp; [{:as options}])</code></div><div class="doc"><div class="markdown"><p>Define a strongly typed instance that can be used with
foreign-interface-instance-&gt;c.  This instance takes a single constructor argument
which is the IFn that it is wrapping.  It has a single typesafe 'invoke' method
taking types defined by the underlying binding and transforming them into types
that Clojure expects - for instance pointers are transformed to/from
<code>tech.v3.datatype.ffi.Pointer</code> upon entry/exit from the wrapped IFn.</p>
<ul>
<li><code>rettype</code> - The return type of the function.</li>
<li><code>argtypes</code> - A possibly empty sequence of argument types.</li>
</ul>
<p>Options:</p>
<ul>
<li><code>:classname</code> - Similar to <code>:classname</code> in 'define-library'.  A class will be
generated to <em>compile-path</em> and after this statement <code>(import classname)</code> will
be a valid call.</li>
</ul>
<p>See foreign-interface-instance-&gt;c for example.</p>
</div></div><div class="src-link"><a href="https://github.com/cnuernber/dtype-next/blob/master/src/tech/v3/datatype/ffi.clj#L435">view source</a></div></div><div class="public anchor" id="var-define-library"><h3>define-library</h3><div class="usage"><code>(define-library fn-defs symbols options)</code><code>(define-library fn-defs options)</code><code>(define-library fn-defs)</code></div><div class="doc"><div class="markdown"><p>Define a library returning the class.  The class can be instantiated with a string
naming the library path or nil for the current process.  After instantiation the
library instance will have strongly typed methods named the same as the
keyword keys in fn-defs efficiently bound to symbols of the same exact name in
library.</p>
<ul>
<li><code>fn-defs</code> - map of fn-name -&gt; {:rettype :argtypes}.
<ul>
<li><code>argtypes</code> -
<ul>
<li><code>:void</code> - return type only.</li>
<li><code>:int8</code> <code>:int16</code> <code>:int32</code> <code>:int64</code></li>
<li><code>:float32</code> <code>:float64</code></li>
<li><code>:size-t</code> - int32 or int64 depending on cpu architecture.</li>
<li><code>:pointer</code> <code>:pointer?</code> - Something convertible to a Pointer type.  Potentially
exception when nil.</li>
</ul>
</li>
<li><code>rettype</code> - any argtype plus :void</li>
</ul>
</li>
</ul>
<p>Options:</p>
<ul>
<li><code>:classname</code> - If classname (a symbol) is provided a .class file is saved to
<em>compile-path</em> after which <code>(import classname)</code> will be a validcall meaning that
after AOT no further reflection or class generation is required to access the
class explicitly.  That being said 'import' does not reload classes that are
already on the classpath so this option is best used after library has stopped
changing.</li>
</ul>
<p>Example:</p>
<pre><code class="language-clojure">user&gt; (dtype-ffi/define-library {:memset {:rettype :pointer
                                          :argtypes [:pointer :int32 :size-t]}}
                                {:classname 'tech.libmemset})
{:library tech.libmemset}
user&gt; (import 'tech.libmemset)
tech.libmemset
user&gt; (def inst (tech.libmemset. nil)) ;;nil for current process
#'user/inst
user&gt; (def test-buf (dtype/make-container :native-heap :float32 (range 10)))
#'user/test-buf
user&gt; test-buf
#native-buffer@0x00007F4E28CE56D0&lt;float32&gt;[10]
[0.000, 1.000, 2.000, 3.000, 4.000, 5.000, 6.000, 7.000, 8.000, 9.000, ]
user&gt; (.memset ^tech.libmemset inst test-buf 0 40)
#object[tech.v3.datatype.ffi.Pointer 0x33013c57 "{:address 0x00007F4E28CE56D0 }"]
user&gt; test-buf
#native-buffer@0x00007F4E28CE56D0&lt;float32&gt;[10]
[0.000, 0.000, 0.000, 0.000, 0.000, 0.000, 0.000, 0.000, 0.000, 0.000, ]
user&gt;
</code></pre>
</div></div><div class="src-link"><a href="https://github.com/cnuernber/dtype-next/blob/master/src/tech/v3/datatype/ffi.clj#L372">view source</a></div></div><div class="public anchor" id="var-define-library.21"><h3>define-library!</h3><h4 class="type">macro</h4><div class="usage"><code>(define-library! lib-varname lib-fns lib-symbols error-checker)</code></div><div class="doc"><div class="markdown"><p>Define a library singleton that will export the defined functions and symbols.</p>
<p>Only jvm-supported primitives work here - no unsigned but if you have the correct
datatype widths the data will be passed unchanged so unsigned does work.</p>
<p>See namespace declaration for full example.</p>
<p>Example:</p>
<pre><code class="language-clojure">  (define-library!
    lib
    '{:memset {:rettype :pointer
               :argtypes [[buffer :pointer]
                          [byte-value :int32]
                          [n-bytes :size-t]]}
      :memcpy {:rettype :pointer
               ;;dst src size-t
               :argtypes [[dst :pointer]
                          [src :pointer]
                          [n-bytes :size-t]]}
      :qsort {:rettype :void
              :argtypes [[data :pointer]
                         [nitems :size-t]
                         [item-size :size-t]
                         [comparator :pointer]]}}
    nil
    nil)
</code></pre>
</div></div><div class="src-link"><a href="https://github.com/cnuernber/dtype-next/blob/master/src/tech/v3/datatype/ffi.clj#L843">view source</a></div></div><div class="public anchor" id="var-define-library-functions"><h3>define-library-functions</h3><h4 class="type">macro</h4><div class="usage"><code>(define-library-functions library-def-symbol find-fn check-error)</code></div><div class="doc"><div class="markdown"><p>Define public callable vars that will call library functions marshaling strings
back and forth.  These vars will call find-fn with the fn-name in a late-bound way
and check-error may be provided and called on a return value assuming :check-error?
is set in the library definition.</p>
<ul>
<li>library-def-symbol - The fully namespaced symbol that points to the function definitions.</li>
<li>find-fn - A function taking one argument - the fn name, and returning the function.</li>
<li>check-error - A function or macro that receives two arguments - the fn definition
from above and the actual un-evaluated function call allowing you to insert pre/post
checks.</li>
</ul>
<p>Example:</p>
<pre><code class="language-clojure">(dt-ffi/define-library-functions avclj.ffi/avcodec-fns find-avcodec-fn check-error)
</code></pre>
</div></div><div class="src-link"><a href="https://github.com/cnuernber/dtype-next/blob/master/src/tech/v3/datatype/ffi.clj#L632">view source</a></div></div><div class="public anchor" id="var-define-library-interface"><h3>define-library-interface</h3><h4 class="type">macro</h4><div class="usage"><code>(define-library-interface fn-defs &amp; {:keys [_classname check-error symbols libraries _header-files], :as opts})</code></div><div class="doc"><div class="markdown"><p>Define public callable vars that will call library functions marshaling strings
back and forth. Returns a library singleton.</p>
<ul>
<li><code>fn-defs</code> - map of fn-name -&gt; {:rettype :argtypes}
<ul>
<li><code>argtypes</code> -
<ul>
<li><code>:void</code> - return type only.</li>
<li><code>:int8</code> <code>:int16</code> <code>:int32</code> <code>:int64</code></li>
<li><code>:float32</code> <code>:float64</code></li>
<li><code>:size-t</code> - int32 or int64 depending on cpu architecture.</li>
<li><code>:pointer</code> <code>:pointer?</code> - Something convertible to a Pointer type.  Potentially
exception when nil.</li>
</ul>
</li>
<li><code>rettype</code> - any argtype plus :void</li>
<li><code>doc</code> - docstring for the function</li>
<li><code>check-error?</code> apply pre/post checks with <code>check-error</code>. default: false</li>
</ul>
</li>
</ul>
<p>Options:</p>
<ul>
<li>
<p><code>:classname</code> - If classname (a symbol) is provided a .class file is saved to
<em>compile-path</em> after which <code>(import classname)</code> will be a validcall meaning that
after AOT no further reflection or class generation is required to access the
class explicitly.  That being said 'import' does not reload classes that are
already on the classpath so this option is best used after library has stopped
changing.</p>
</li>
<li>
<p><code>:check-error</code> - A function or macro that receives two arguments - the fn definition
from above and the actual un-evaluated function call allowing you to insert pre/post
checks.</p>
</li>
<li>
<p><code>:symbols</code> - A sequence of symbols in the shared library that should be available
for use with <code>find-symbol</code></p>
</li>
<li>
<p><code>:libraries</code> - (graalvm only) A sequence of dependent shared libraries that should be loaded.</p>
</li>
<li>
<p><code>:header-files</code> - (graalvm only) A sequence of header files.</p>
</li>
</ul>
<p>Example:</p>
<pre><code class="language-clojure">
user&gt; (dt-ffi/define-library-interface
        {:memset {:rettype :pointer
                  :argtypes [['p :pointer]
                             ['x :int32]
                             ['len :size-t]]}})
user&gt; (def test-buf (dtype/make-container :native-heap :float32 (range 10)))
#'user/test-buf
user&gt; test-buf
#native-buffer@0x00007F4E28CE56D0&lt;float32&gt;[10]
[0.000, 1.000, 2.000, 3.000, 4.000, 5.000, 6.000, 7.000, 8.000, 9.000, ]
user&gt; (memset test-buf 0 40)
#object[tech.v3.datatype.ffi.Pointer 0x33013c57 "{:address 0x00007F4E28CE56D0 }"]
user&gt; test-buf
#native-buffer@0x00007F4E28CE56D0&lt;float32&gt;[10]
[0.000, 0.000, 0.000, 0.000, 0.000, 0.000, 0.000, 0.000, 0.000, 0.000, ]
</code></pre>
</div></div><div class="src-link"><a href="https://github.com/cnuernber/dtype-next/blob/master/src/tech/v3/datatype/ffi.clj#L673">view source</a></div></div><div class="public anchor" id="var-enable-string-.3Ec-stats.21"><h3>enable-string-&gt;c-stats!</h3><div class="usage"><code>(enable-string-&gt;c-stats! enabled?)</code><code>(enable-string-&gt;c-stats!)</code></div><div class="doc"><div class="markdown"><p>Enable tracking how often string-&gt;c is getting called.</p>
</div></div><div class="src-link"><a href="https://github.com/cnuernber/dtype-next/blob/master/src/tech/v3/datatype/ffi.clj#L209">view source</a></div></div><div class="public anchor" id="var-find-library"><h3>find-library</h3><div class="usage"><code>(find-library libname)</code></div><div class="doc"><div class="markdown"><p>This method is useful to check if loading a library will work.  If successful,
returns the library name that did finally succeed.  This may be different from
<code>libname</code> in the case where java.library.path has been used to actively find the
library.</p>
</div></div><div class="src-link"><a href="https://github.com/cnuernber/dtype-next/blob/master/src/tech/v3/datatype/ffi.clj#L340">view source</a></div></div><div class="public anchor" id="var-find-symbol"><h3>find-symbol</h3><div class="usage"><code>(find-symbol libname symbol-name)</code><code>(find-symbol symbol-name)</code></div><div class="doc"><div class="markdown"><p>Find a symbol in a library.  A library symbol is guaranteed to have a conversion to
a pointer.</p>
</div></div><div class="src-link"><a href="https://github.com/cnuernber/dtype-next/blob/master/src/tech/v3/datatype/ffi.clj#L363">view source</a></div></div><div class="public anchor" id="var-foreign-interface-instance-.3Ec"><h3>foreign-interface-instance-&gt;c</h3><div class="usage"><code>(foreign-interface-instance-&gt;c ffi-def foreign-inst)</code></div><div class="doc"><div class="markdown"><p>Convert an instance of the above foreign interface definition into a Pointer
suitable to be called from C.  Callers must ensure that foreign-inst is visible
to the gc the entire time the foreign system has a reference to the pointer.</p>
<ul>
<li><code>foreign-inst</code> - an instance of the class defined by 'define-foreign-interface'.</li>
</ul>
</div></div><div class="src-link"><a href="https://github.com/cnuernber/dtype-next/blob/master/src/tech/v3/datatype/ffi.clj#L467">view source</a></div></div><div class="public anchor" id="var-if-class"><h3>if-class</h3><h4 class="type">macro</h4><div class="usage"><code>(if-class class-name then)</code><code>(if-class class-name then else?)</code></div><div class="doc"><div class="markdown"></div></div><div class="src-link"><a href="https://github.com/cnuernber/dtype-next/blob/master/src/tech/v3/datatype/ffi.clj#L658">view source</a></div></div><div class="public anchor" id="var-instantiate-class"><h3>instantiate-class</h3><div class="usage"><code>(instantiate-class cls &amp; args)</code></div><div class="doc"><div class="markdown"><p>Utility function to instantiate a class via its first constructor in its list
of declared constructors.  Works with classes returned from 'define-library'
and 'define-foreign-interface'.  Uses reflection.</p>
</div></div><div class="src-link"><a href="https://github.com/cnuernber/dtype-next/blob/master/src/tech/v3/datatype/ffi.clj#L298">view source</a></div></div><div class="public anchor" id="var-instantiate-foreign-interface"><h3>instantiate-foreign-interface</h3><div class="usage"><code>(instantiate-foreign-interface ffi-def ifn)</code></div><div class="doc"><div class="markdown"><p>Instantiate a foreign interface defintion.  This returns an instance object which
can then be converted into a c-pointer via <code>foreign-interface-instance-&gt;c</code>.</p>
</div></div><div class="src-link"><a href="https://github.com/cnuernber/dtype-next/blob/master/src/tech/v3/datatype/ffi.clj#L457">view source</a></div></div><div class="public anchor" id="var-instantiate-library"><h3>instantiate-library</h3><div class="usage"><code>(instantiate-library library-def libpath)</code></div><div class="doc"><div class="markdown"><p>Uses reflection to instantiate a library</p>
</div></div><div class="src-link"><a href="https://github.com/cnuernber/dtype-next/blob/master/src/tech/v3/datatype/ffi.clj#L429">view source</a></div></div><div class="public anchor" id="var-jdk-ffi.3F"><h3>jdk-ffi?</h3><div class="usage"><code>(jdk-ffi?)</code></div><div class="doc"><div class="markdown"><p>Is the JDK foreign function interface available?</p>
</div></div><div class="src-link"><a href="https://github.com/cnuernber/dtype-next/blob/master/src/tech/v3/datatype/ffi.clj#L127">view source</a></div></div><div class="public anchor" id="var-jdk-mmodel.3F"><h3>jdk-mmodel?</h3><div class="usage"><code>(jdk-mmodel?)</code></div><div class="doc"><div class="markdown"><p>Is the JDK native memory model available?</p>
</div></div><div class="src-link"><a href="https://github.com/cnuernber/dtype-next/blob/master/src/tech/v3/datatype/ffi.clj#L143">view source</a></div></div><div class="public anchor" id="var-jna-ffi.3F"><h3>jna-ffi?</h3><div class="usage"><code>(jna-ffi?)</code></div><div class="doc"><div class="markdown"><p>Is JNA's ffi interface available?</p>
</div></div><div class="src-link"><a href="https://github.com/cnuernber/dtype-next/blob/master/src/tech/v3/datatype/ffi.clj#L135">view source</a></div></div><div class="public anchor" id="var-library-loadable.3F"><h3>library-loadable?</h3><div class="usage"><code>(library-loadable? libname)</code></div><div class="doc"><div class="markdown"></div></div><div class="src-link"><a href="https://github.com/cnuernber/dtype-next/blob/master/src/tech/v3/datatype/ffi.clj#L358">view source</a></div></div><div class="public anchor" id="var-library-singleton"><h3>library-singleton</h3><div class="usage"><code>(library-singleton library-def-var library-sym-var library-def-opts)</code><code>(library-singleton library-def-var)</code></div><div class="doc"><div class="markdown"><p>Create a singleton object, ideally assigned to a variable with defonce, that
you can reset to auto-reload the bindings i.e. with new function definitions
at the repl.</p>
<ul>
<li><code>library-def-var</code> must be something that deref's to the latest library definition.</li>
</ul>
<pre><code class="language-clojure">(defonce ^:private lib (dt-ffi/library-singleton #'avcodec-fns))

;;Safe to call on uninitialized library.  If the library is initialized, however,
;;a new library instance is created from the latest avcodec-fns
(dt-ffi/library-singelton-reset! lib)

(defn set-library!
  [libpath]
  (dt-ffi/library-singelton-set! lib libpath))
(defn- find-avcodec-fn
  [fn-kwd]
  (dt-ffi/library-singelton-find-fn lib fn-kwd))
</code></pre>
</div></div><div class="src-link"><a href="https://github.com/cnuernber/dtype-next/blob/master/src/tech/v3/datatype/ffi.clj#L569">view source</a></div></div><div class="public anchor" id="var-make-ptr"><h3>make-ptr</h3><div class="usage"><code>(make-ptr dtype prim-init-value options)</code><code>(make-ptr dtype prim-init-value)</code></div><div class="doc"><div class="markdown"><p>Make an object convertible to a pointer that points to  single value of type
<code>dtype</code>.</p>
</div></div><div class="src-link"><a href="https://github.com/cnuernber/dtype-next/blob/master/src/tech/v3/datatype/ffi.clj#L477">view source</a></div></div><div class="public anchor" id="var-PLibrarySingleton"><h3>PLibrarySingleton</h3><h4 class="type">protocol</h4><div class="usage"></div><div class="doc"><div class="markdown"><p>Protocol to allow easy definition of a library singleton that manages re-creating
the library definition when the library data changes and also recreating the
library instance if necessary.</p>
</div></div><div class="members"><h4>members</h4><div class="inner"><div class="public anchor" id="var-library-singleton-definition"><h3>library-singleton-definition</h3><div class="usage"><code>(library-singleton-definition lib-singleton)</code></div><div class="doc"><div class="markdown"><p>Return the library definition.</p>
</div></div></div><div class="public anchor" id="var-library-singleton-find-fn"><h3>library-singleton-find-fn</h3><div class="usage"><code>(library-singleton-find-fn lib-singleton fn-name)</code></div><div class="doc"><div class="markdown"><p>Find a bound function in the library.  Returns an implementation of
clojure.lang.IFn that takes only the specific arguments.</p>
</div></div></div><div class="public anchor" id="var-library-singleton-find-symbol"><h3>library-singleton-find-symbol</h3><div class="usage"><code>(library-singleton-find-symbol lib-singleton sym-name)</code></div><div class="doc"><div class="markdown"><p>Find a symbol in the library.  Returns a pointer.</p>
</div></div></div><div class="public anchor" id="var-library-singleton-library"><h3>library-singleton-library</h3><div class="usage"><code>(library-singleton-library lib-singleton)</code></div><div class="doc"><div class="markdown"><p>Return the library instance</p>
</div></div></div><div class="public anchor" id="var-library-singleton-library-path"><h3>library-singleton-library-path</h3><div class="usage"><code>(library-singleton-library-path lib-singleton)</code></div><div class="doc"><div class="markdown"><p>Get the bound library path</p>
</div></div></div><div class="public anchor" id="var-library-singleton-reset.21"><h3>library-singleton-reset!</h3><div class="usage"><code>(library-singleton-reset! lib-singleton)</code></div><div class="doc"><div class="markdown"><p>Regenerate library bindings and bind a new instance to allow repl-style
iterative development.</p>
</div></div></div><div class="public anchor" id="var-library-singleton-set.21"><h3>library-singleton-set!</h3><div class="usage"><code>(library-singleton-set! lib-singleton libpath)</code></div><div class="doc"><div class="markdown"><p>Set the library path, generate the library and create a new instance.</p>
</div></div></div><div class="public anchor" id="var-library-singleton-set-instance.21"><h3>library-singleton-set-instance!</h3><div class="usage"><code>(library-singleton-set-instance! lib-singleton libinst)</code></div><div class="doc"><div class="markdown"><p>In some cases such as graal native pathways you have to hard-set the definition and instance.</p>
</div></div></div></div></div><div class="src-link"><a href="https://github.com/cnuernber/dtype-next/blob/master/src/tech/v3/datatype/ffi.clj#L501">view source</a></div></div><div class="public anchor" id="var-PToPointer"><h3>PToPointer</h3><h4 class="type">protocol</h4><div class="usage"></div><div class="doc"><div class="markdown"></div></div><div class="members"><h4>members</h4><div class="inner"><div class="public anchor" id="var--.3Epointer"><h3>-&gt;pointer</h3><div class="usage"><code>(-&gt;pointer item)</code></div><div class="doc"><div class="markdown"><p>Convert an item into a Pointer, throwing an exception upon failure.</p>
</div></div></div><div class="public anchor" id="var-convertible-to-pointer.3F"><h3>convertible-to-pointer?</h3><div class="usage"><code>(convertible-to-pointer? item)</code></div><div class="doc"><div class="markdown"><p>Query whether an item is convertible to a pointer.</p>
</div></div></div></div></div><div class="src-link"><a href="https://github.com/cnuernber/dtype-next/blob/master/src/tech/v3/datatype/ffi.clj#L151">view source</a></div></div><div class="public anchor" id="var-ptr-.3Estruct"><h3>ptr-&gt;struct</h3><div class="usage"><code>(ptr-&gt;struct struct-type ptr)</code></div><div class="doc"><div class="markdown"><p>Given a struct type and a pointer return a struct whose data starts
at the address of the pointer.</p>
<pre><code class="language-clojure">  (let [codec (dt-ffi/ptr-&gt;struct (:datatype-name @av-context/codec-def*) codec-ptr)]
       ...)
</code></pre>
</div></div><div class="src-link"><a href="https://github.com/cnuernber/dtype-next/blob/master/src/tech/v3/datatype/ffi.clj#L804">view source</a></div></div><div class="public anchor" id="var-set-ffi-impl.21"><h3>set-ffi-impl!</h3><div class="usage"><code>(set-ffi-impl! ffi-kwd)</code></div><div class="doc"><div class="markdown"><p>Set the global ffi implementation.  Options are</p>
<ul>
<li>:jdk - namespace <code>'tech.v3.datatype.ffi.mmodel/ffi-fns</code> - only available with jdk's foreign function module enabled.</li>
<li>:jna - namespace <code>''tech.v3.datatype.ffi.jna/ffi-fns</code> - available if JNA version 5+ is in the classpath.</li>
</ul>
</div></div><div class="src-link"><a href="https://github.com/cnuernber/dtype-next/blob/master/src/tech/v3/datatype/ffi.clj#L311">view source</a></div></div><div class="public anchor" id="var-string-.3Ec"><h3>string-&gt;c</h3><div class="usage"><code>(string-&gt;c str-data &amp; [{:keys [encoding], :as options}])</code></div><div class="doc"><div class="markdown"><p>Convert a java String to a zero-padded c-string.  Available encodings are</p>
<ul>
<li><code>:ascii</code>, <code>:utf-8</code> (default), <code>:utf-16</code>, <code>:utf-16LE</code>, <code>utf-16-BE</code> and <code>:utf-32</code></li>
</ul>
<p>String data will be zero padded.</p>
</div></div><div class="src-link"><a href="https://github.com/cnuernber/dtype-next/blob/master/src/tech/v3/datatype/ffi.clj#L231">view source</a></div></div><div class="public anchor" id="var-string-.3Ec-data-histogram"><h3>string-&gt;c-data-histogram</h3><div class="usage"><code>(string-&gt;c-data-histogram)</code></div><div class="doc"><div class="markdown"></div></div><div class="src-link"><a href="https://github.com/cnuernber/dtype-next/blob/master/src/tech/v3/datatype/ffi.clj#L223">view source</a></div></div><div class="public anchor" id="var-struct-member-ptr"><h3>struct-member-ptr</h3><div class="usage"><code>(struct-member-ptr data-struct member)</code></div><div class="doc"><div class="markdown"><p>Get a pointer to a struct data member.</p>
<pre><code class="language-clojure">   (swscale/sws_scale sws-ctx
                      (struct-member-ptr input-frame :data)
                      (struct-member-ptr input-frame :linesize)
                      0 (:height input-frame)
                      (struct-member-ptr encoder-frame :data)
                      (struct-member-ptr encoder-frame :linesize))
</code></pre>
</div></div><div class="src-link"><a href="https://github.com/cnuernber/dtype-next/blob/master/src/tech/v3/datatype/ffi.clj#L821">view source</a></div></div><div class="public anchor" id="var-utf16-platform-encoding"><h3>utf16-platform-encoding</h3><div class="usage"><code>(utf16-platform-encoding)</code></div><div class="doc"><div class="markdown"><p>Get the utf-16 encoding that matches the current platform so you can encode
a utf-16 string without a bom.</p>
</div></div><div class="src-link"><a href="https://github.com/cnuernber/dtype-next/blob/master/src/tech/v3/datatype/ffi.clj#L158">view source</a></div></div><div class="public anchor" id="var-utf32-platform-encoding"><h3>utf32-platform-encoding</h3><div class="usage"><code>(utf32-platform-encoding)</code></div><div class="doc"><div class="markdown"><p>Get the utf-16 encoding that matches the current platform so you can encode
a utf-16 string without a bom.</p>
</div></div><div class="src-link"><a href="https://github.com/cnuernber/dtype-next/blob/master/src/tech/v3/datatype/ffi.clj#L167">view source</a></div></div><div class="public anchor" id="var-windows-platform.3F"><h3>windows-platform?</h3><div class="usage"><code>(windows-platform?)</code></div><div class="doc"><div class="markdown"></div></div><div class="src-link"><a href="https://github.com/cnuernber/dtype-next/blob/master/src/tech/v3/datatype/ffi.clj#L176">view source</a></div></div></div></body></html>